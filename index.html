<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Beneficios - An√°lisis de Jugadores</title>
    <script src="https://cdn.plot.ly/plotly-2.32.0.min.js" charset="utf-8"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üéæ</text></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üéæ</text></svg>">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0f172a;
            color: #e2e8f0;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            padding: 40px;
            border-radius: 20px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            text-align: center;
        }
        
        h1 {
            font-size: 2.8em;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #60a5fa 0%, #a78bfa 100%);
            -webkit-background-clip: text;
            background-clip: text;
        }
        
        .subtitle {
            font-size: 1.1em;
            color: #94a3b8;
        }
        
        /* Panel de Filtros */
        .filter-panel {
            background: #1e293b;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        
        .filter-title {
            font-size: 1.3em;
            margin-bottom: 20px;
            color: #60a5fa;
            font-weight: 600;
        }
        
        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
        }
        
        .filter-group label {
            margin-bottom: 8px;
            color: #cbd5e1;
            font-weight: 500;
            font-size: 0.9em;
        }
        
        .filter-group select,
        .filter-group input {
            padding: 12px;
            border: 2px solid #334155;
            border-radius: 8px;
            background: #0f172a;
            color: #e2e8f0;
            font-size: 1em;
            transition: all 0.3s;
        }
        
        .filter-group select:focus,
        .filter-group input:focus {
            outline: none;
            border-color: #60a5fa;
            box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.1);
        }
        
        .filter-actions {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1em;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(96, 165, 250, 0.4);
        }
        
        .btn-secondary {
            background: #334155;
            color: #e2e8f0;
        }
        
        .btn-secondary:hover {
            background: #475569;
        }
        
        /* Tarjetas de m√©tricas */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            border-left: 4px solid #60a5fa;
            transition: transform 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-icon {
            font-size: 2em;
            margin-bottom: 10px;
        }
        
        .stat-label {
            font-size: 0.9em;
            color: #94a3b8;
            margin-bottom: 8px;
        }
        
        .stat-value {
            font-size: 2.5em;
            font-weight: 700;
            background: linear-gradient(135deg, #60a5fa 0%, #a78bfa 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        /* Secciones */
        .section {
            background: #1e293b;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            width: 100%;
            box-sizing: border-box; /* Importante */
        }

        .section-title {
            font-size: 1.8em;
            margin-bottom: 25px;
            color: #60a5fa;
            font-weight: 600;
            border-bottom: 2px solid #334155;
            padding-bottom: 15px;
            width: 100%;
        }

        .chart-container {
            background: #0f172a;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            width: 100%;
            box-sizing: border-box;
            overflow: hidden; /* Evita desbordes */
        }

        /* Contenedor flexible para gr√°ficos lado a lado */
        .charts-horizontal {
            display: flex;
            gap: 20px;
            width: 100%;
            flex-wrap: wrap;
            align-items: center;
            justify-content: center;
        }

        .charts-horizontal .chart-container {
            flex: 1;
            min-width: 300px;
            max-width: 100%; /* Evita desborde */
            height: 530px;
            overflow: hidden; /* Recorta desborde */
        }

        /* Asegurar que los gr√°ficos usen todo el espacio */
        #grafico-scatter, 
        #grafico-barras {
            width: 100% !important;
            height: 90% !important;
        }

        .js-plotly-plot,
        .plot-container {
            max-width: 100% !important;
        }
        
        /* Tabla */
        .table-container {
            overflow-x: auto;
            border-radius: 12px;
            background: #0f172a;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th {
            background: #334155;
            color: #e2e8f0;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
            cursor: pointer;
            user-select: none;
        }
        
        th:hover {
            background: #475569;
        }
        
        td {
            padding: 5px 5px;
            border-bottom: 1px solid #334155;
            color: #cbd5e1;
            text-align: center;
        }
        
        tr:hover {
            background: #1e293b;
        }
        
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }
        
        .badge-1 { background: #912cf0; color: white; }
        .badge-2 { background: #d77c32; color: white; }
        .badge-3 { background: #d6e13c; color: #0f172a; }
        
        /* Loading */
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
            font-size: 1.2em;
            color: #60a5fa;
        }
        
        .loading.active {
            display: block;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            h1 {
                font-size: 2em;
            }
            
            .filter-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
                width: 100%;
            }
            
            /* Apilar gr√°ficos en m√≥vil */
            .charts-horizontal {
                flex-direction: column;
                align-items: center;
                justify-content: center;
            }
            
            .charts-horizontal .chart-container {
                width: 100%;
                min-width: unset;
                height: 400px; /* M√°s bajo en m√≥vil */
            }
            
            .section {
                padding: 15px;
            }
        }

        @media (max-width: 1200px) {
            /* Apilar en tablets tambi√©n */
            .charts-horizontal .chart-container {
                min-width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üìä Beneficios a Jugadores</h1>
            <p class="subtitle">An√°lisis de Jugadores por √çndice de Esfuerzo</p>
        </header>
        
        <!-- Panel de Filtros -->
        <div class="filter-panel">
            <h2 class="filter-title">üîç Filtros Interactivos</h2>
            <div class="filter-grid">
                <div class="filter-group">
                    <label for="filter-beneficio">Beneficio de Pases obtenidos</label>
                    <select id="filter-beneficio">
                        <option value="all">Todos</option>
                        <option value="3">3 Pases</option>
                        <option value="2">2 Pases</option>
                        <option value="1">1 Pase</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="search-localidad">Localidad</label>
                    <select id="search-localidad">
                        <option value="all">Todas las localidades</option>
                        <!-- Se llena din√°micamente con JavaScript -->
                    </select>
                </div>

                <div class="filter-actions">
                    <!-- <button class="btn btn-primary" onclick="aplicarFiltros()">Aplicar Filtros</button> -->
                    <button class="btn btn-secondary" style="width: 100%;" onclick="resetearFiltros()" >Resetear Filtros</button>
                </div>
            
            </div>
            <div> 
                <div class="filter-group">
                    <label for="filter-eventos-range">Eventos: <span id="eventos-value">0</span></label>
                    <input type="range" id="filter-eventos-range" min="0" value="0">
                </div>

                <div class="filter-group">
                    <label>Km Totales Acum: <span id="km-range-label">Cargando...</span></label>
                    <div style="display: flex; flex-direction: column; gap: 8px;">
                        <div>
                            <label style="font-size: 0.85em; color: #94a3b8;">M√≠nimo</label>
                            <input type="range" id="filter-km-min" step="50" style="width: 100%;">
                        </div>
                        <div>
                            <label style="font-size: 0.85em; color: #94a3b8;">M√°ximo</label>
                            <input type="range" id="filter-km-max" step="50" style="width: 100%;">
                        </div>
                    </div>
                </div>
            </div>

        </div>
        
        <!-- M√©tricas Principales -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">üë•</div>
                <div class="stat-label">Jugadores Beneficiados</div>
                <div class="stat-value" id="stat-jugadores">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üéÅ</div>
                <div class="stat-label">Pases Libres Otorgados</div>
                <div class="stat-value" id="stat-beneficios">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üìç</div>
                <div class="stat-label">Localidades Alcanzadas</div>
                <div class="stat-value" id="stat-localidad">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üèÜ</div>
                <div class="stat-label">Participaciones Totales</div>
                <div class="stat-value" id="stat-eventos">-</div>
            </div>
        </div>
        
        <!-- An√°lisis de Esfuerzo y Top Jugadores -->
        <div class="section">
            <h2 class="section-title">üìä An√°lisis de Desempe√±o</h2>
            
            <div class="charts-horizontal">
                <div class="chart-container">
                    <h4 style="color: #e2e8f0; margin-bottom: 15px; font-size: 1.1rem;">üìà Esfuerzo vs Distancia</h4>
                    <div id="grafico-scatter"></div>
                </div>
                
                <div class="chart-container">
                    <h4 style="color: #e2e8f0; margin-bottom: 15px; font-size: 1.1rem;">üèÖ Top 10 Jugadores</h4>
                    <div id="grafico-barras"></div>
                </div>
            </div>
        </div>
                
        <!-- Frecuencia vs Distancia y Asignaci√≥n de Beneficios -->
        <div class="section">
            <h2 class="section-title">üìä An√°lisis de Frecuencia y Beneficios</h2>
            
            <div class="charts-horizontal">
                <div class="chart-container">
                    <h4 style="color: #e2e8f0; margin-bottom: 15px; font-size: 1.1rem;">üìä Frecuencia vs Distancia</h4>
                    <div id="grafico-frecuencia"></div>
                </div>
                
                <div class="chart-container">
                    <h4 style="color: #e2e8f0; margin-bottom: 15px; font-size: 1.1rem;">üéØ Asignaci√≥n de Beneficios</h4>
                    <div id="grafico-beneficios"></div>
                </div>
            </div>
        </div>
        
        <!-- Distribuci√≥n Geogr√°fica y por Localidad -->
        <div class="section">
            <h2 class="section-title">üó∫Ô∏è Distribuci√≥n de Beneficios</h2>
            
            <div class="charts-horizontal">
                <div class="chart-container">
                    <h4 style="color: #e2e8f0; margin-bottom: 15px; font-size: 1.1rem;">üó∫Ô∏è Mapa Geogr√°fico</h4>
                    <div id="mapa-geografico"></div>
                </div>
                
                <div class="chart-container">
                    <h4 style="color: #e2e8f0; margin-bottom: 15px; font-size: 1.1rem;">üç© Por Localidad</h4>
                    <div id="grafico-dona"></div>
                </div>
            </div>
        </div>

        <div class="section">
            <h2 class="section-title">üìã Conclusiones Finales</h2>
            
            <div style="background: #334155; padding: 30px; border-radius: 12px; line-height: 1.8;">
                
                <!-- Introducci√≥n -->
                <div style="margin-bottom: 30px;">
                    <h3 style="color: #60a5fa; font-size: 1.4em; margin-bottom: 15px;">üéØ Resumen Ejecutivo</h3>
                    <p style="color: #cbd5e1; font-size: 1.05em;">
                        El an√°lisis comparativo entre el m√©todo original (umbral fijo de 200 km promedio) y el nuevo sistema 
                        basado en <strong style="color: #a78bfa;">√≠ndice de esfuerzo multidimensional</strong> demuestra mejoras 
                        significativas en la equidad y precisi√≥n de la asignaci√≥n de beneficios.
                    </p>
                </div>

                <!-- Hallazgos Principales -->
                <div style="margin-bottom: 30px;">
                    <h3 style="color: #60a5fa; font-size: 1.4em; margin-bottom: 15px;">üîç Hallazgos Principales</h3>
                    
                    <div style="display: grid; gap: 20px;">
                        <!-- Hallazgo 1 -->
                        <div style="background: rgba(239, 68, 68, 0.1); padding: 20px; border-radius: 10px; border-left: 4px solid #ef4444;">
                            <h4 style="color: #ef4444; margin-bottom: 10px; font-size: 1.1em;">‚ùå Sobre-beneficiaci√≥n Detectada</h4>
                            <p style="color: #cbd5e1; margin-bottom: 10px;">
                                Jugadores que recib√≠an beneficios con el m√©todo anterior pero que <strong>no califican</strong> 
                                seg√∫n el √≠ndice de esfuerzo integral.
                            </p>
                            <p style="color: #94a3b8; font-size: 0.95em;">
                                <strong>Impacto:</strong> Estos casos representan asignaciones ineficientes donde jugadores con 
                                alta distancia promedio pero baja participaci√≥n recib√≠an beneficios sin justificaci√≥n completa.
                            </p>
                        </div>

                        <!-- Hallazgo 2 -->
                        <div style="background: rgba(16, 185, 129, 0.1); padding: 20px; border-radius: 10px; border-left: 4px solid #10b981;">
                            <h4 style="color: #10b981; margin-bottom: 10px; font-size: 1.1em;">‚úÖ Sub-beneficiaci√≥n Corregida</h4>
                            <p style="color: #cbd5e1; margin-bottom: 10px;">
                                Jugadores que <strong>NO recib√≠an beneficios</strong> con el m√©todo anterior pero que ahora califican 
                                gracias al an√°lisis multidimensional.
                            </p>
                            <p style="color: #94a3b8; font-size: 0.95em;">
                                <strong>Impacto:</strong> Estos casos identifican jugadores con esfuerzo constante (alta participaci√≥n, 
                                km totales significativos, percentil 90 elevado) que el m√©todo simple ignoraba por tener km promedio bajo.
                            </p>
                        </div>

                        <!-- Hallazgo 3 -->
                        <div style="background: rgba(96, 165, 250, 0.1); padding: 20px; border-radius: 10px; border-left: 4px solid #60a5fa;">
                            <h4 style="color: #60a5fa; margin-bottom: 10px; font-size: 1.1em;">üéØ Precisi√≥n Mejorada</h4>
                            <p style="color: #cbd5e1; margin-bottom: 10px;">
                                El nuevo m√©todo alcanza una precisi√≥n superior, clasificando correctamente tanto a beneficiados 
                                como a no beneficiados.
                            </p>
                            <p style="color: #94a3b8; font-size: 0.95em;">
                                <strong>Impacto:</strong> Reduce la asignaci√≥n arbitraria y aumenta la confianza en el sistema 
                                de incentivos, premiando el esfuerzo real y sostenido.
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Ventajas del Nuevo M√©todo -->
                <div style="margin-bottom: 30px;">
                    <h3 style="color: #60a5fa; font-size: 1.4em; margin-bottom: 15px;">üí° Ventajas del √çndice de Esfuerzo</h3>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px;">
                        <div style="background: #1e293b; padding: 15px; border-radius: 8px;">
                            <div style="color: #a78bfa; font-size: 1.8em; margin-bottom: 8px;">üìä</div>
                            <strong style="color: #e2e8f0; display: block; margin-bottom: 5px;">Multidimensional</strong>
                            <p style="color: #94a3b8; font-size: 0.9em; margin: 0;">
                                Combina km totales (35%), percentil 90 (25%) y frecuencia de eventos (40%)
                            </p>
                        </div>

                        <div style="background: #1e293b; padding: 15px; border-radius: 8px;">
                            <div style="color: #a78bfa; font-size: 1.8em; margin-bottom: 8px;">‚öñÔ∏è</div>
                            <strong style="color: #e2e8f0; display: block; margin-bottom: 5px;">Equitativo</strong>
                            <p style="color: #94a3b8; font-size: 0.9em; margin: 0;">
                                Reconoce tanto esfuerzo puntual como constancia en participaci√≥n
                            </p>
                        </div>

                        <div style="background: #1e293b; padding: 15px; border-radius: 8px;">
                            <div style="color: #a78bfa; font-size: 1.8em; margin-bottom: 8px;">üéöÔ∏è</div>
                            <strong style="color: #e2e8f0; display: block; margin-bottom: 5px;">Adaptativo</strong>
                            <p style="color: #94a3b8; font-size: 0.9em; margin: 0;">
                                Los percentiles se ajustan din√°micamente al comportamiento de toda la poblaci√≥n
                            </p>
                        </div>

                        <div style="background: #1e293b; padding: 15px; border-radius: 8px;">
                            <div style="color: #a78bfa; font-size: 1.8em; margin-bottom: 8px;">üîç</div>
                            <strong style="color: #e2e8f0; display: block; margin-bottom: 5px;">Transparente</strong>
                            <p style="color: #94a3b8; font-size: 0.9em; margin: 0;">
                                Metodolog√≠a clara y replicable que puede ser auditada f√°cilmente
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Conclusi√≥n Final -->
                <div style="background: linear-gradient(135deg, #1e293b 0%, #334155 100%); padding: 25px; border-radius: 10px; border: 2px solid #60a5fa;">
                    <h3 style="color: #60a5fa; font-size: 1.4em; margin-bottom: 15px; text-align: center;">üéØ Conclusi√≥n</h3>
                    <p style="color: #e2e8f0; font-size: 1.1em; text-align: center; line-height: 1.8; margin: 0;">
                        La transici√≥n del m√©todo basado en <strong>umbral fijo</strong> al sistema de 
                        <strong style="color: #a78bfa;">√≠ndice de esfuerzo multidimensional</strong> representa una mejora 
                        significativa en equidad, precisi√≥n y justicia distributiva. El nuevo modelo reconoce y premia 
                        el compromiso sostenido de los jugadores, no solo eventos aislados de alta distancia, generando 
                        un sistema de incentivos m√°s robusto y defendible.
                    </p>
                </div>

            </div>
        </div>
        <!-- Tabla de contraste -->
        <div class="section">
            <h2 class="section-title">üìã Detalle de Beneficiados Antes/Despu√©s</h2>
            <div class="table-container">
                <table id="tabla-beneficiados">
                    <thead>
                        <tr>
                            <th onclick="sortTable(0)">Jug. ID ‚Üï</th>
                            <th onclick="sortTable(1)">Localidad ‚Üï</th>
                            <th onclick="sortTable(2)">Km Prom. ‚Üï</th>
                            <th onclick="sortTable(3)">√çndice Esf. ‚Üï</th>
                            <th onclick="sortTable(4)">Benef. Orig. ‚Üï</th>
                            <th onclick="sortTable(5)">Benef. Actual ‚Üï</th>
                            <th onclick="sortTable(6)">Categor√≠a ‚Üï</th>
                            <th onclick="sortTable(7)">Eventos ‚Üï</th>
                        </tr>
                    </thead>
                    <tbody id="tabla-body">
                        <!-- Se llena con JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- An√°lisis de Redistribuci√≥n -->
        <div class="section">
            <h2 class="section-title">üî¨ An√°lisis de Redistribuci√≥n</h2>
            
            <div class="charts-horizontal">                
                <div class="chart-container">
                    <h4 style="color: #e2e8f0; margin-bottom: 15px; font-size: 1.1rem;">üéØ Matriz de Confusi√≥n</h4>
                    <div id="matriz-confusion"></div>
                </div>

                <!-- M√©tricas de impacto -->
                <div class="stats-grid" style="margin-top: 30px;">
                    <div class="stat-card" style="border-left-color: #ef4444;">
                        <div class="stat-icon">üéÅ</div>
                        <div class="stat-value" id="metric-beneficios-redistribuibles" style="color: #ef4444;">0</div>
                        <div class="stat-label">Beneficiarios Reasignados</div>
                    </div>
                    
                    <div class="stat-card" style="border-left-color: #10b981;">
                        <div class="stat-icon">‚úÖ</div>
                        <div class="stat-value" id="metric-nuevos-beneficiarios" style="color: #10b981;">0</div>
                        <div class="stat-label">Nuevos Beneficiarios</div>
                    </div>
                    
                    <div class="stat-card" style="border-left-color: #60a5fa;">
                        <div class="stat-icon">üéØ</div>
                        <div class="stat-value" id="metric-precision-mejorada" style="color: #60a5fa;">0%</div>
                        <div class="stat-label">Tasa de acuerdo entre m√©todos</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="loading" id="loading">
            <p>‚è≥ Cargando datos...</p>
        </div>
    </div>

    <script>
        // Variables globales
        let datosOriginales = [];
        let datosFiltrados = [];
        
        // Funci√≥n de Haversine
        function haversine(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const toRad = (deg) => deg * Math.PI / 180;
            
            const dLat = toRad(lat2 - lat1);
            const dLon = toRad(lon2 - lon1);
            
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            
            return R * c;
        }
        
        // Procesar datos del CSV
        function procesarDatos(csv) {
            Papa.parse(csv, {
                header: true,
                dynamicTyping: true,
                complete: function(results) {
                    const df = results.data.filter(row => row.jugador_id);
                    
                    // Calcular distancias
                    df.forEach(row => {
                        row.distancia_km = haversine(
                            row.origen_lat,
                            row.origen_lon,
                            row.destino_lat,
                            row.destino_lon
                        );
                    });
                    
                    // Agrupar por jugador
                    const jugadores = {};
                    df.forEach(row => {
                        const id = String(row.jugador_id);
                        if (!jugadores[id]) {
                            jugadores[id] = {
                                jugador_id: id,
                                localidad: row.origen,
                                origen_lat: row.origen_lat,
                                origen_lon: row.origen_lon,
                                distancias: [],
                                torneos: new Set(),
                                destinos: new Set()
                            };
                        }
                        jugadores[id].distancias.push(row.distancia_km);
                        jugadores[id].torneos.add(row.torneo_id);
                        jugadores[id].destinos.add(row.destino);
                    });
                    
                    // Calcular m√©tricas
                    datosOriginales = Object.values(jugadores).map(j => {
                        const distancias = j.distancias.sort((a, b) => a - b);
                        const km_totales = distancias.reduce((a, b) => a + b, 0);
                        const km_prom = km_totales / distancias.length;
                        const km_p90 = distancias[Math.floor(distancias.length * 0.9)];
                        const cantidad_eventos = j.torneos.size;
                        
                        return {
                            jugador_id: j.jugador_id,
                            localidad: j.localidad,
                            origen_lat: j.origen_lat,
                            origen_lon: j.origen_lon,
                            km_totales: km_totales,
                            km_prom: km_prom,
                            km_p90: km_p90,
                            cantidad_eventos: cantidad_eventos,
                            sedes_visitadas: j.destinos.size
                        };
                    });
                    
                    // Calcular √≠ndice de esfuerzo
                    const max_eventos = Math.max(...datosOriginales.map(d => d.cantidad_eventos));
                    datosOriginales.forEach(d => {
                        d.indice_esfuerzo_base = d.km_totales * 0.35 + d.km_p90 * 0.25 + d.cantidad_eventos * 0.40;
                        d.participacion_norm = d.cantidad_eventos / max_eventos;
                        d.indice_esfuerzo = d.indice_esfuerzo_base * Math.pow(d.participacion_norm, 0.5);
                    });
                    
                    // Calcular percentiles correctamente (manejo de empates tipo rank average)
                    const indicesOrdenados = datosOriginales
                        .map(d => d.indice_esfuerzo)
                        .sort((a, b) => a - b);

                    const N = indicesOrdenados.length;

                    datosOriginales.forEach(d => {

                        const menores = indicesOrdenados.filter(v => v < d.indice_esfuerzo).length;
                        const iguales = indicesOrdenados.filter(v => v === d.indice_esfuerzo).length;

                        // rank promedio como Pandas (empates promedio)
                        const rankPromedio = menores + (iguales + 1) / 2;

                        // percentil EXACTO estilo pandas
                        d.percentil_esfuerzo = rankPromedio / N;

                        // Redondeo defensivo contra floating point
                        const p = Number(d.percentil_esfuerzo.toFixed(10));

                        if (p >= 0.97) d.beneficio = 3;
                        else if (p >= 0.95) d.beneficio = 2;
                        else if (p >= 0.92) d.beneficio = 1;
                        else d.beneficio = 0;
                    });

                    // === AQU√ç CALCULAMOS LOS CAMPOS PARA EL CONTRASTE ===
                    const UMBRAL_KM = 200;

                    // Calcular an√°lisis comparativo PRIMERO
                    datosOriginales.forEach(d => {
                        // M√©todo original: solo por distancia
                        d.beneficio_original = d.km_prom > UMBRAL_KM ? 1 : 0;
                        d.beneficio_nuevo = d.beneficio > 0 ? 1 : 0;
                        
                        // Categor√≠a para an√°lisis
                        if (d.beneficio_original === 1 && d.beneficio_nuevo === 1) {
                            d.categoria_beneficio = 'correcto_beneficiado';
                        } else if (d.beneficio_original === 0 && d.beneficio_nuevo === 0) {
                            d.categoria_beneficio = 'correcto_no_beneficiado';
                        } else if (d.beneficio_original === 1 && d.beneficio_nuevo === 0) {
                            d.categoria_beneficio = 'sobre_beneficiado';
                        } else if (d.beneficio_original === 0 && d.beneficio_nuevo === 1) {
                            d.categoria_beneficio = 'sub_beneficiado';
                        }
                    });

                    // Separar beneficiados vs no beneficiados
                    datosBeneficiados = datosOriginales.filter(d => d.beneficio > 0);
                    datosNoBeneficiados = datosOriginales.filter(d => d.beneficio === 0);

                    // Inicializar datosFiltrados con TODOS los beneficiados
                    datosFiltrados = [...datosBeneficiados];  // ‚Üê Usar copia de datosBeneficiados

                    // Primero inicializar filtros (configura los rangos)
                    inicializarFiltros();

                    // Luego actualizar dashboard
                    actualizarDashboard();

                    console.log('%c=== VALIDACI√ìN DE M√âTRICAS DE IMPACTO ===', 'color: #60a5fa; font-size: 18px; font-weight: bold');

                    const total = datosOriginales.length;

                    // Contar por categor√≠a
                    const categorias = {
                        sobre_beneficiados: datosOriginales.filter(d => d.categoria_beneficio === 'sobre_beneficiado').length,
                        sub_beneficiados: datosOriginales.filter(d => d.categoria_beneficio === 'sub_beneficiado').length,
                        correcto_beneficiado: datosOriginales.filter(d => d.categoria_beneficio === 'correcto_beneficiado').length,
                        correcto_no_beneficiado: datosOriginales.filter(d => d.categoria_beneficio === 'correcto_no_beneficiado').length
                    };

                    const correctos_total = categorias.correcto_beneficiado + categorias.correcto_no_beneficiado;
                    const precision = ((correctos_total / total) * 100).toFixed(1);

                    // Resumen general
                    console.log('%c--- RESUMEN GENERAL ---', 'color: #a78bfa; font-size: 14px; font-weight: bold');
                    console.table({
                        'Total de jugadores': total,
                        'Sobre-beneficiados (ten√≠an, no merecen)': categorias.sobre_beneficiados,
                        'Sub-beneficiados (merecen, no ten√≠an)': categorias.sub_beneficiados,
                        'Correcto beneficiado (ambos m√©todos OK)': categorias.correcto_beneficiado,
                        'Correcto NO beneficiado (ambos m√©todos OK)': categorias.correcto_no_beneficiado,
                        'Total correctos': correctos_total,
                        'Precisi√≥n del nuevo m√©todo': `${precision}%`
                    });

                    // Validar que sumen 100%
                    const suma_categorias = categorias.sobre_beneficiados + categorias.sub_beneficiados + 
                                            categorias.correcto_beneficiado + categorias.correcto_no_beneficiado;
                    const check = suma_categorias === total ? '‚úÖ' : '‚ùå';
                    console.log(`%c${check} Validaci√≥n: ${suma_categorias} de ${total} jugadores clasificados`, 
                        suma_categorias === total ? 'color: #10b981' : 'color: #ef4444');

                    // Desglose detallado
                    console.log('%c--- DESGLOSE M√âTODO VIEJO ---', 'color: #f59e0b; font-size: 14px');
                    const beneficiados_viejo = datosOriginales.filter(d => d.beneficio_original === 1).length;
                    const no_beneficiados_viejo = datosOriginales.filter(d => d.beneficio_original === 0).length;
                    console.table({
                        'Beneficiados (km_prom > 200)': beneficiados_viejo,
                        'NO beneficiados (km_prom ‚â§ 200)': no_beneficiados_viejo,
                        'Total': beneficiados_viejo + no_beneficiados_viejo
                    });

                    console.log('%c--- DESGLOSE M√âTODO NUEVO ---', 'color: #10b981; font-size: 14px');
                    const beneficiados_nuevo = datosOriginales.filter(d => d.beneficio_nuevo === 1).length;
                    const no_beneficiados_nuevo = datosOriginales.filter(d => d.beneficio_nuevo === 0).length;
                    console.table({
                        'Beneficiados (√≠ndice de esfuerzo)': beneficiados_nuevo,
                        'NO beneficiados': no_beneficiados_nuevo,
                        'Total': beneficiados_nuevo + no_beneficiados_nuevo
                    });

                    // Matriz de confusi√≥n manual
                    console.log('%c--- MATRIZ DE CONFUSI√ìN ---', 'color: #8b5cf6; font-size: 14px');
                    console.table({
                        'Viejo=S√ç, Nuevo=S√ç (correcto_beneficiado)': categorias.correcto_beneficiado,
                        'Viejo=S√ç, Nuevo=NO (sobre_beneficiado)': categorias.sobre_beneficiados,
                        'Viejo=NO, Nuevo=S√ç (sub_beneficiado)': categorias.sub_beneficiados,
                        'Viejo=NO, Nuevo=NO (correcto_no_beneficiado)': categorias.correcto_no_beneficiado
                    });

                    // Ejemplos espec√≠ficos
                    console.log('%c--- EJEMPLOS DE SOBRE-BENEFICIADOS ---', 'color: #ef4444; font-weight: bold');
                    const ejemplos_sobre = datosOriginales
                        .filter(d => d.categoria_beneficio === 'sobre_beneficiado')
                        .slice(0, 5)
                        .map(d => ({
                            ID: d.jugador_id,
                            Localidad: d.localidad,
                            'Km Prom': d.km_prom.toFixed(1),
                            'Km Totales': d.km_totales.toFixed(1),
                            'Eventos': d.cantidad_eventos,
                            '√çndice': d.indice_esfuerzo.toFixed(2),
                            'Percentil': (d.percentil_esfuerzo * 100).toFixed(1) + '%'
                        }));
                    console.table(ejemplos_sobre);

                    console.log('%c--- EJEMPLOS DE SUB-BENEFICIADOS ---', 'color: #10b981; font-weight: bold');
                    const ejemplos_sub = datosOriginales
                        .filter(d => d.categoria_beneficio === 'sub_beneficiado')
                        .slice(0, 5)
                        .map(d => ({
                            ID: d.jugador_id,
                            Localidad: d.localidad,
                            'Km Prom': d.km_prom.toFixed(1),
                            'Km Totales': d.km_totales.toFixed(1),
                            'Eventos': d.cantidad_eventos,
                            '√çndice': d.indice_esfuerzo.toFixed(2),
                            'Beneficio Nuevo': d.beneficio,
                            'Percentil': (d.percentil_esfuerzo * 100).toFixed(1) + '%'
                        }));
                    console.table(ejemplos_sub);

                    // Verificar discrepancias
                    console.log('%c--- VERIFICACIONES ADICIONALES ---', 'color: #60a5fa; font-size: 14px');
                    const sin_categoria = datosOriginales.filter(d => !d.categoria_beneficio).length;
                    console.log(`Jugadores sin categor√≠a asignada: ${sin_categoria} ${sin_categoria > 0 ? '‚ùå ERROR' : '‚úÖ'}`);

                    const beneficio_mal = datosOriginales.filter(d => 
                        (d.beneficio > 0 && d.beneficio_nuevo !== 1) || 
                        (d.beneficio === 0 && d.beneficio_nuevo !== 0)
                    ).length;
                    console.log(`Inconsistencia beneficio vs beneficio_nuevo: ${beneficio_mal} ${beneficio_mal > 0 ? '‚ùå ERROR' : '‚úÖ'}`);

                    console.log('%c=== FIN DE VALIDACI√ìN ===', 'color: #60a5fa; font-size: 16px; font-weight: bold');
                }
            });
        }

        // Actualizar label del rango de km
        function actualizarRangoKm() {
            const min = document.getElementById('filter-km-min').value;
            const max = document.getElementById('filter-km-max').value;
            console.log('Label actualizado:', min, '-', max);
            document.getElementById('km-range-label').textContent = `${min} - ${max} km`;
        }

        // Poblar select de localidades
        function inicializarFiltros() {
            // Poblar localidades usando datosBeneficiados
            const select = document.getElementById('search-localidad');
            const localidadesUnicas = [...new Set(datosBeneficiados.map(d => d.localidad))]
                .filter(l => l)
                .sort();
            
            select.innerHTML = '<option value="all">Todas las localidades</option>';
            localidadesUnicas.forEach(localidad => {
                const option = document.createElement('option');
                option.value = localidad;
                option.textContent = localidad;
                select.appendChild(option);
            });
            
            // Configurar rango de km seg√∫n datos reales
            const kmValues = datosBeneficiados.map(d => d.km_totales);
            const kmMin = Math.floor(Math.min(...kmValues) / 50) * 50;
            const kmMax = Math.ceil(Math.max(...kmValues) / 50) * 50; 
            
            document.getElementById('filter-km-min').min = kmMin;
            document.getElementById('filter-km-min').max = kmMax;
            document.getElementById('filter-km-min').value = kmMin;
            
            document.getElementById('filter-km-max').min = kmMin;
            document.getElementById('filter-km-max').max = kmMax;
            document.getElementById('filter-km-max').value = kmMax;

            // Configurar el slider de eventos usando datosBeneficiados
            const maxEventos = Math.max(...datosBeneficiados.map(d => d.cantidad_eventos));
            const slider = document.getElementById('filter-eventos-range');
            slider.max = maxEventos;
            slider.value = 0;
        
            actualizarRangoKm();
        }

        // Filtrar autom√°ticamente cuando cambian los filtros
        document.getElementById('filter-beneficio').addEventListener('change', aplicarFiltros);
        document.getElementById('search-localidad').addEventListener('change', aplicarFiltros);
        document.getElementById('filter-km-min').addEventListener('input', function() {
            actualizarRangoKm();
            aplicarFiltros();
        });
        document.getElementById('filter-km-max').addEventListener('input', function() {
            actualizarRangoKm();
            aplicarFiltros();
        });
        
        // Actualizar valor al mover el slider
        document.getElementById('filter-eventos-range').addEventListener('input', function() {
            document.getElementById('eventos-value').textContent = this.value;
            aplicarFiltros();
        });

        // Aplicar filtros
        function aplicarFiltros() {
            const beneficio = document.getElementById('filter-beneficio').value;
            const localidad = document.getElementById('search-localidad').value;
            const kmMin = parseFloat(document.getElementById('filter-km-min').value) || 0;
            const kmMax = parseFloat(document.getElementById('filter-km-max').value) || Infinity;
            const eventosMin = parseInt(document.getElementById('filter-eventos-range').value) || 0;
            
            datosFiltrados = datosBeneficiados.filter(d => {
                if (beneficio !== 'all' && d.beneficio !== parseInt(beneficio)) return false;
                if (localidad !== 'all' && d.localidad !== localidad) return false;
                if (d.cantidad_eventos < eventosMin) return false;
                if (d.km_totales < kmMin || d.km_totales > kmMax) return false;
                return true;
            });
            
            actualizarDashboard();
        }
        
        // Resetear filtros
        function resetearFiltros() {
            document.getElementById('filter-beneficio').value = 'all';
            document.getElementById('search-localidad').value = 'all';

            const slider = document.getElementById('filter-eventos-range');
            slider.value = 0;
            document.getElementById('eventos-value').textContent = 0;

            const kmValues = datosBeneficiados.map(d => d.km_totales);
            const kmMin = Math.floor(Math.min(...kmValues));
            const kmMax = Math.ceil(Math.max(...kmValues));

            document.getElementById('filter-km-min').value = kmMin;
            document.getElementById('filter-km-max').value = kmMax;

            actualizarRangoKm();

            datosFiltrados = [...datosBeneficiados];

            actualizarDashboard();
        }
        
        // Actualizar todo el dashboard
        function actualizarDashboard() {
            actualizarMetricas();
            actualizarMetricasImpacto();
            actualizarMapa();
            actualizarScatter();
            actualizarBarras();
            actualizarFrecuencia();
            actualizarBeneficios();
            actualizarDonaBeneficios();
            actualizarTabla();
            crearMatrizConfusion();
        }
        
        // Actualizar m√©tricas
        function actualizarMetricas() {
            const jugadores = new Set(datosFiltrados.map(d => d.jugador_id)).size;
            const beneficios = datosFiltrados.reduce((sum, d) => sum + d.beneficio, 0);
            const km = datosFiltrados.reduce((sum, d) => sum + d.km_totales, 0);
            const localidades = new Set(datosFiltrados.map(d => d.localidad)).size;
            const eventos = datosFiltrados.reduce((sum, d) => sum + d.cantidad_eventos, 0);
            document.getElementById('stat-jugadores').textContent = jugadores;
            document.getElementById('stat-beneficios').textContent = beneficios;
            //document.getElementById('stat-km').textContent = Math.round(km).toLocaleString();
            document.getElementById('stat-localidad').textContent = localidades;
            document.getElementById('stat-eventos').textContent = eventos;
        }
        
        // Actualizar mapa
        function actualizarMapa() {
            const colorMap = {1: '#912cf0', 2: '#d77c32', 3: '#d6e13c'};
            
            const traces = [1, 2, 3].map(b => {
                const data = datosFiltrados.filter(d => d.beneficio === b);
                return {
                    type: 'scattermapbox',
                    lat: data.map(d => d.origen_lat),
                    lon: data.map(d => d.origen_lon),
                    mode: 'markers',
                    marker: {
                        size: data.map(d => Math.sqrt(d.indice_esfuerzo) * 1),
                        color: colorMap[b],
                        opacity: 0.8
                    },
                    text: data.map(d => d.localidad),
                    customdata: data,
                    hovertemplate: '<b>%{text}</b><br>' +
                                   'Jugador: %{customdata.jugador_id}<br>' +
                                   '√çndice: %{customdata.indice_esfuerzo:.2f}<br>' +
                                   'Eventos: %{customdata.cantidad_eventos}<br>' +
                                   'Km Acum.: %{customdata.km_totales:.1f}<br>' +
                                   'Km Prom..: %{customdata.km_prom:.1f}<br>' +
                                   'Beneficio: %{customdata.beneficio}<br>' +
                                   '<extra></extra>',
                    name: `Beneficio ${b}`
                };
            });
            
            const layout = {
                //title: {
                //    text: 'Distribuci√≥n geogr√°fica de los beneficios',
                //    font: {size: 18, color: '#e2e8f0'},
                //    x: 0.5,  // Centrar
                //    xanchor: 'center'
                //},
                mapbox: {
                    style: 'carto-darkmatter',
                    center: {
                        lat: datosFiltrados.reduce((sum, d) => sum + d.origen_lat, 0) / datosFiltrados.length,
                        lon: datosFiltrados.reduce((sum, d) => sum + d.origen_lon, 0) / datosFiltrados.length
                    },
                    zoom: 6
                },
                margin: {r: 0, t: 50, l: 0, b: 0},  // Dar espacio arriba
                //height: 600,
                paper_bgcolor: '#0f172a',
                plot_bgcolor: '#0f172a',
                showlegend: true,
                legend: {
                    orientation: 'h',  // Horizontal
                    x: 0.5,            // Centrar
                    xanchor: 'center',
                    y: 1.05,           // Arriba del gr√°fico
                    yanchor: 'bottom',
                    font: {color: '#e2e8f0'},
                    bgcolor: 'rgba(15, 23, 42, 0.8)'  // Fondo semi-transparente
                }
            };
            
            Plotly.newPlot('mapa-geografico', traces, layout, {responsive: true});
        }
        
        // Actualizar scatter
        function actualizarScatter() {
            const trace = {
                x: datosFiltrados.map(d => d.km_prom),
                y: datosFiltrados.map(d => d.km_totales),
                mode: 'markers',
                marker: {
                    size: 25,
                    color: datosFiltrados.map(d => d.indice_esfuerzo),
                    colorscale: 'Viridis',
                    showscale: true,
                    colorbar: {
                        title: '√çndice',
                        tickfont: {color: '#e2e8f0'},
                        titlefont: {color: '#e2e8f0'}
                    }
                },
                text: datosFiltrados.map(d => d.localidad),
                customdata: datosFiltrados,
                hovertemplate: '<b>%{text}</b><br>' +
                               'Km prom: %{x:.1f}<br>' +
                               'Km totales: %{y:.1f}<br>' +
                               'Eventos: %{customdata.cantidad_eventos}<br>' +
                               '<extra></extra>',
                type: 'scatter'
            };
            
            const layout = {
                title: 'Esfuerzo real vs distancia promedio',
                xaxis: {title: 'Km promedio por evento', color: '#e2e8f0', gridcolor: '#334155'},
                yaxis: {title: 'Km Acumulados', color: '#e2e8f0', gridcolor: '#334155'},
                paper_bgcolor: '#0f172a',
                plot_bgcolor: '#0f172a',
                font: {color: '#e2e8f0'},
                //height: 500
            };
            
            Plotly.newPlot('grafico-scatter', [trace], layout, {responsive: true});
        }
        
        // Actualizar barras
        function actualizarBarras() {
            const top10 = [...datosFiltrados]
                .sort((a, b) => b.indice_esfuerzo - a.indice_esfuerzo)
                .slice(0, 10);
            
            const trace = {
                y: top10.map(d => `Jugador ${d.jugador_id}`),
                x: top10.map(d => d.indice_esfuerzo),
                type: 'bar',
                orientation: 'h',
                marker: {
                    color: top10.map(d => d.indice_esfuerzo),
                    colorscale: 'Viridis'
                },
                text: top10.map(d => d.indice_esfuerzo.toFixed(1)),
                textposition: 'auto',
                customdata: top10,
                hovertemplate: '<b>Jugador %{customdata.jugador_id}</b><br>' +
                            '√çndice: %{x:.2f}<br>' +
                            'Localidad: %{customdata.localidad}<br>' +
                            'Km Acum.: %{customdata.km_totales:.1f}<br>' +
                            'Km Prom.: %{customdata.km_prom:.1f}<br>' +
                            '<extra></extra>',
                width: 0.8
            };
            
            const layout = {
                title: {
                    text: 'Top 10 Jugadores por √çndice de Esfuerzo',
                    font: {size: 18, color: '#e2e8f0'}
                },
                xaxis: {
                    title: '√çndice de Esfuerzo', 
                    color: '#e2e8f0', 
                    gridcolor: '#334155'
                },
                yaxis: {
                    type: 'category',  // Forzar como categ√≥rico
                    autorange: 'reversed',
                    color: '#e2e8f0',
                    tickfont: {size: 11},
                    ticksuffix: '  '
                },
                paper_bgcolor: '#0f172a',
                plot_bgcolor: '#0f172a',
                font: {color: '#e2e8f0'},
                //height: 600,  
                bargap: 0.15,
                margin: {l: 90, r: 40, t: 60, b: 60}
            };
            
            Plotly.newPlot('grafico-barras', [trace], layout, {responsive: true});
        }
        
        // Actualizar frecuencia
        function actualizarFrecuencia() {
            const trace = {
                x: datosFiltrados.map(d => d.km_prom),
                y: datosFiltrados.map(d => d.cantidad_eventos),
                mode: 'markers',
                marker: {
                    size: datosFiltrados.map(d => Math.sqrt(d.indice_esfuerzo) * 1),
                    color: datosFiltrados.map(d => d.indice_esfuerzo),
                    colorscale: 'Viridis',
                    showscale: true,
                    colorbar: {
                        title: '√çndice',
                        tickfont: {color: '#e2e8f0'},
                        titlefont: {color: '#e2e8f0'}
                    }
                },
                text: datosFiltrados.map(d => d.localidad),
                customdata: datosFiltrados,
                hovertemplate: '<b>%{text}</b><br>' +
                               'Jugador: %{customdata.jugador_id}<br>' +
                               'Km prom: %{x:.1f}<br>' +
                               'Eventos: %{y}<br>' +
                               '√çndice: %{customdata.indice_esfuerzo:.2f}<br>' +
                               '<extra></extra>',
                type: 'scatter'
            };
            
            const layout = {
                title: 'Frecuencia vs Distancia (tama√±o = esfuerzo total)',
                xaxis: {title: 'Km promedio por evento', color: '#e2e8f0', gridcolor: '#334155'},
                yaxis: {title: 'Cantidad de eventos', color: '#e2e8f0', gridcolor: '#334155'},
                paper_bgcolor: '#0f172a',
                plot_bgcolor: '#0f172a',
                font: {color: '#e2e8f0'},
                //height: 500
            };
            
            Plotly.newPlot('grafico-frecuencia', [trace], layout, {responsive: true});
        }
        
        // Actualizar beneficios
        function actualizarBeneficios() {
            const colorMap = {1: '#912cf0', 2: '#d77c32', 3: '#d6e13c'};
            
            const traces = [1, 2, 3].map(b => {
                const data = datosFiltrados.filter(d => d.beneficio === b);
                return {
                    x: data.map(d => d.km_prom),
                    y: data.map(d => d.cantidad_eventos),
                    mode: 'markers',
                    marker: {
                        size: data.map(d => Math.sqrt(d.indice_esfuerzo) * 1),
                        color: colorMap[b]
                    },
                    text: data.map(d => d.localidad),
                    customdata: data,
                    hovertemplate: '<b>%{text}</b><br>' +
                                   'Jugador: %{customdata.jugador_id}<br>' +
                                   'Km prom: %{x:.1f}<br>' +
                                   'Eventos: %{y}<br>' +
                                   '√çndice: %{customdata.indice_esfuerzo:.2f}<br>' +
                                   'Percentil: %{customdata.percentil_esfuerzo:.2f}<br>' +
                                   '<extra></extra>',
                    name: `Beneficio ${b}`,
                    type: 'scatter'
                };
            });
            
            const layout = {
                title: 'Asignaci√≥n de Beneficios basada en Esfuerzo Acumulado',
                xaxis: {title: 'Km promedio por evento', color: '#e2e8f0', gridcolor: '#334155'},
                yaxis: {title: 'Cantidad de eventos disputados', color: '#e2e8f0', gridcolor: '#334155'},
                paper_bgcolor: '#0f172a',
                plot_bgcolor: '#0f172a',
                font: {color: '#e2e8f0'},
                showlegend: true,
                legend: {font: {color: '#e2e8f0'}},
                //height: 500
            };
            
            Plotly.newPlot('grafico-beneficios', traces, layout, {responsive: true});
        }
        
        // Gr√°fico de anillo - Beneficios por localidad
        function actualizarDonaBeneficios() {
            // Agrupar beneficios por localidad
            const beneficiosPorLocalidad = {};
            datosFiltrados.forEach(d => {
                if (!beneficiosPorLocalidad[d.localidad]) {
                    beneficiosPorLocalidad[d.localidad] = 0;
                }
                beneficiosPorLocalidad[d.localidad] += d.beneficio;
            });
            // Convertir a arrays y ordenar
            const localidades = Object.keys(beneficiosPorLocalidad);
            const valores = Object.values(beneficiosPorLocalidad);
            const trace = {
                values: valores,
                labels: localidades,
                type: 'pie',
                hole: 0.4,
                marker: {
                    colors: ['#912cf0', '#d77c32', '#d6e13c', '#60a5fa', '#a78bfa', '#34d399', '#f472b6', '#fb923c'],
                    line: {
                        color: '#0f172a',
                        width: 2
                    }
                },
                textposition: 'inside',
                textinfo: 'label+percent',
                hovertemplate: '<b>%{label}</b><br>' +
                            'Beneficios: %{value}<br>' +
                            'Porcentaje: %{percent}<br>' +
                            '<extra></extra>'
            };
            const layout = {
                title: {
                    text: 'Distribuci√≥n de Beneficios por Localidad',
                    font: {size: 18, color: '#e2e8f0'}
                },
                paper_bgcolor: '#0f172a',
                plot_bgcolor: '#0f172a',
                font: {color: '#e2e8f0'},
                showlegend: true,
                legend: {
                    font: {color: '#e2e8f0'},
                    orientation: 'v',
                    x: 1.05,
                    y: 0.5
                }
            };
            Plotly.newPlot('grafico-dona', [trace], layout, {responsive: true});
        }
        
        ///////////////////////////////////////////
        ///////////// Resumen final ///////////////
        ///////////////////////////////////////////
        
        // Gr√°fico de tabla - Contraste beneficios
        function actualizarTabla() {
            const tbody = document.getElementById('tabla-body');
            tbody.innerHTML = '';

            if (!datosOriginales || datosOriginales.length === 0) return;

            // Excluir correcto_no_beneficiado
            const datosContraste = datosOriginales.filter(d =>
                d.categoria_beneficio !== 'correcto_no_beneficiado'
            );
            // Orden l√≥gico de categor√≠as
            const ordenCategoria = {
                'sub_beneficiado': 1,
                'correcto_beneficiado': 2,
                'sobre_beneficiado': 3
            };
            const sorted = [...datosContraste].sort((a, b) => {
                if (ordenCategoria[a.categoria_beneficio] !== ordenCategoria[b.categoria_beneficio]) {
                    return ordenCategoria[a.categoria_beneficio] - ordenCategoria[b.categoria_beneficio];
                }
                return b.indice_esfuerzo - a.indice_esfuerzo;
            });

            sorted.forEach(d => {
                const row = tbody.insertRow();

                // Color seg√∫n categor√≠a
                const colores = {
                    'sobre_beneficiado': 'rgba(239, 68, 68, 0.1)',
                    'sub_beneficiado': 'rgba(16, 185, 129, 0.1)',
                    'correcto_beneficiado': 'rgba(96, 165, 250, 0.1)'
                };

                row.style.background = colores[d.categoria_beneficio] || 'transparent';

                const beneficioViejo = d.beneficio_original === 1 ? '‚úÖ' : '‚ùå';
                const beneficioNuevo = d.beneficio_nuevo === 1 ? '‚úÖ' : '‚ùå';
                const coincidencia =
                    d.beneficio_original === 1 && d.beneficio_nuevo === 1 ? '‚úÖ‚úÖ' : '';

                row.innerHTML = `
                    <td>${d.jugador_id ?? '-'}</td>
                    <td>${d.localidad ?? '-'}</td>
                    <td>${(d.km_prom ?? 0).toFixed(1)}</td>
                    <td>${(d.indice_esfuerzo ?? 0).toFixed(2)}</td>
                    <td style="text-align:center;">${beneficioViejo}</td>
                    <td style="text-align:center;">${beneficioNuevo}</td>
                    <td>
                        <span class="badge ${
                            d.categoria_beneficio === 'sobre_beneficiado' ? 'badge-1' :
                            d.categoria_beneficio === 'sub_beneficiado' ? 'badge-3' :
                            'badge-2'
                        }" style="font-size:0.75em; padding:3px 8px;">
                            ${d.categoria_beneficio.replace(/_/g, ' ').toUpperCase()}
                        </span>
                    </td>
                    <td>${d.cantidad_eventos ?? 0}</td>
                `;
            });
        }

        // Ordenar tabla
        function sortTable(col) {
            const tbody = document.getElementById('tabla-body');
            const rows = Array.from(tbody.rows);
            const isAsc = tbody.dataset.sortCol === col.toString() && tbody.dataset.sortDir === 'asc';
            
            rows.sort((a, b) => {
                const aVal = a.cells[col].textContent;
                const bVal = b.cells[col].textContent;
                const aNum = parseFloat(aVal);
                const bNum = parseFloat(bVal);
                
                if (!isNaN(aNum) && !isNaN(bNum)) {
                    return isAsc ? aNum - bNum : bNum - aNum;
                }
                return isAsc ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
            });
            
            tbody.innerHTML = '';
            rows.forEach(row => tbody.appendChild(row));
            
            tbody.dataset.sortCol = col;
            tbody.dataset.sortDir = isAsc ? 'desc' : 'asc';
        }

        // Matriz Confusion
        function crearMatrizConfusion() {
            const categorias = {
                correctos_beneficiados: datosOriginales.filter(d => d.categoria_beneficio === 'correcto_beneficiado').length,
                sobre_beneficiados: datosOriginales.filter(d => d.categoria_beneficio === 'sobre_beneficiado').length,
                sub_beneficiados: datosOriginales.filter(d => d.categoria_beneficio === 'sub_beneficiado').length,
                correctos_no_beneficiados: datosOriginales.filter(d => d.categoria_beneficio === 'correcto_no_beneficiado').length
            };
            
            const z = [
                [categorias.correctos_beneficiados, categorias.sobre_beneficiados],
                [categorias.sub_beneficiados, categorias.correctos_no_beneficiados]
            ];
            
            const trace = {
                z: z,
                x: ['Beneficiado', 'No Beneficiado'],
                y: ['Beneficiado', 'No Beneficiado'],
                type: 'heatmap',
                colorscale: 'Viridis',
                showscale: true,
                text: z.map(row => row.map(v => `${v} Jugad.`)),
                texttemplate: '%{text}',
                textfont: {size: 14, color: 'white'},
                hovertemplate: 'Original: %{y}<br>Nuevo: %{x}<br>Jugadores: %{z}<extra></extra>'
            };
            
            const layout = {
                title: 'Matriz de Confusi√≥n: M√©todo Original vs Nuevo',
                xaxis: { title: 'M√©todo Nuevo' },
                yaxis: { title: 'M√©todo Original', autorange: 'reversed', ticksuffix: '  '},
                margin: {l: 100, r: 40, t: 60, b: 60},
                paper_bgcolor: '#0f172a',
                plot_bgcolor: '#0f172a',
                font: { color: '#e2e8f0' },
                //height: 400
            };
            
            Plotly.newPlot('matriz-confusion', [trace], layout, { responsive: true });
        }
        
        // Metricas impacto
        function actualizarMetricasImpacto() {
            // Calcular categor√≠as
            const total = datosOriginales.length;
            const categorias = {
                sobre_beneficiados: datosOriginales.filter(d => d.categoria_beneficio === 'sobre_beneficiado').length,
                sub_beneficiados: datosOriginales.filter(d => d.categoria_beneficio === 'sub_beneficiado').length,
                correctos: datosOriginales.filter(d =>
                    d.categoria_beneficio === 'correcto_beneficiado' ||
                    d.categoria_beneficio === 'correcto_no_beneficiado'
                ).length
            };
            
            // Actualizar elementos en el DOM
            const beneficiosElem = document.getElementById('metric-beneficios-redistribuibles');
            const nuevosElem = document.getElementById('metric-nuevos-beneficiarios');
            const precisionElem = document.getElementById('metric-precision-mejorada');
            
            if (beneficiosElem) {
                beneficiosElem.textContent = categorias.sobre_beneficiados;
            }
            
            if (nuevosElem) {
                nuevosElem.textContent = categorias.sub_beneficiados;
            }
            
            if (precisionElem) {
                const precision = ((categorias.correctos / total) * 100).toFixed(1);
                precisionElem.textContent = `${precision}%`;
            }
        }

        // Cargar datos
        window.addEventListener('load', function() {
            const csvUrl = './data/jugadores.csv';
            fetch(csvUrl)
                .then(response => response.text())
                .then(csv => procesarDatos(csv))
                .catch(error => {
                    console.error('Error cargando datos:', error);
                    alert('Error cargando datos. Aseg√∫rate de que el archivo CSV est√© en la ruta correcta.');
                });
        });
    </script>
</body>
</html>